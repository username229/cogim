name: CI/CD para Cogim Project

on:
  push:
    branches:
      - main # O pipeline será executado sempre que houver um push para a branch 'main'

jobs:
  # ===============================================
  # JOB 1: BUILD E PUSH DAS IMAGENS DOCKER (CI)
  # Este job constrói as imagens e as envia para o ACR
  # ===============================================
  build-and-push-containers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Login no Azure usando o Service Principal (AZURE_CREDENTIALS)
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Login no Azure Container Registry (ACR)
      - name: ACR Login
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          # Não é necessário fornecer username/password explicitamente; o Azure Login trata disso.
          
      # 3. Define a tag da imagem (usando o SHA do commit para unicidade)
      - name: Set Image Tag
        id: vars
        run: echo "sha_short=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT
        
      # 4. Build & Push da Imagem do Backend
      - name: Build and Push Backend Image
        run: |
          # A variável de ambiente DOCKER_BUILDKIT=1 permite o build moderno
          DOCKER_BUILDKIT=1 docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/cogim-backend:${{ steps.vars.outputs.sha_short }} -f Dockerfile.backend .
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/cogim-backend:${{ steps.vars.outputs.sha_short }}

      # 5. Build & Push da Imagem do Frontend (com Nginx)
      - name: Build and Push Frontend/Proxy Image
        run: |
          DOCKER_BUILDKIT=1 docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/cogim-frontend:${{ steps.vars.outputs.sha_short }} -f Dockerfile.frontend .
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/cogim-frontend:${{ steps.vars.outputs.sha_short }}

  # ==================================================
  # JOB 2: DEPLOYMENT DA AZURE FUNCTION APP (CD)
  # ==================================================
  deploy-function-app:
    runs-on: ubuntu-latest
    needs: build-and-push-containers # Executa somente se o Job 1 for bem-sucedido
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js version 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build
        # Instala dependências da Function App
        run: npm install 

      # 1. Deploy para a Function App
      - name: 'Deploy Azure Function'
        uses: Azure/functions-action@v1
        with:
          # Usa o nome da Function App do segredo
          app-name: ${{ secrets.AZURE_FUNCTION_APP_NAME }} 
          package: .
          # Usa o perfil de publicação (XML) do segredo
          publish-profile: ${{ secrets.AZURE_FUNCTION_PUBLISH_PROFILE }}
